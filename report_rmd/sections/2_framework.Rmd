# A bayesian framework to improve geographical location of mobile phone events {#framework}

In this section, we present the methodological framework on which all our present population estimates are based. First, we present the research problem : mapping the unknown location of mobile phone users. Then, we present the bayesian model used to perform this mapping in a probabilistic way. Specifically, we highlight one of the main advantage of this framework : it is highly flexible, in the sense that it can accommodate a wide range of situations as regards information availability.




## Spatial mapping of mobile phone events

Each phone event, defined as a connection of a mobile device to a network, leaves a digital track. As such, these tracks represent a major opportunity to get a very fine view of spatial footprints of mobile phone users. 

However, these tracks generally do not contain information on the geographical location of the device. Data collected by mobile network operators (MNO) are primarily devoted to customers billing and network analysis. But these tasks only require the identification of the antenna that the mobile device has connected to. Although geographical coordinates of the antenna tower are known precisely, the exact location of the user is not. Consequently, when using mobile phone data to describe human behavior, the first step is to map events to a likely location.

Various methods can be used to proceed to this mapping. The main factor in choosing between them is the amount of available technical information on the MNO network. However, such information is rarely available, and may be considered as sensitive by MNOs when it is. Thus, many authors in the literature resort to a common approximation : coverage areas are modelled by a Voronoi tessellation. Each point of the space is mapped to its closest antenna, which produces a partition of the space in convex polygons (figure \@ref(fig:voronoi2007)). Coverage of a given antenna is then assumed to correspond to the polygon in which it is located.

There are several downsides to relying on Voronoi tessellation to approximate the geographical location of phone users. First, many technical factors influence the choice of an antenna by a particular device, such as the type of the antenna (omnidirectional or directional), its coverage range, the generation of wireless technology used by the device (2G, 3G, 4G) and even its brand (different brands use different device-cell matching algorithms). As a result, it is often the case that a given phone connects to an antenna which is not the closest one. Besides, Voronoi tessellation constitutes a partition of the space, and thus fails to take into account the fact that antennae coverage areas actually overlap, so that one antenna can take over if another one is overloaded. In fact, mobile phones connections switch from one antenna to another even when standing still. These shortcomings explain why counting present population based on this hypothesis can generate significant bias.

```{r voronoi2007, echo = FALSE, fig.align='center', fig.cap='Voronoi tessellation of France based on the location of Orange antennae in 2007 (source : Sakarovitch et al., 2019)', out.width='90%'}
knitr::include_graphics('sections/2_framework/voronoi_france_2007.png')
```

Another important downside to using Voronoi tessellation is that the shape of its polygons are entirely dependent on the spatial distribution of antennae. This poses two problems. First, there is no reason for Voronoi polygons to match any of the spatial units used in official statistics. Yet, if we want to combine present population estimates with other sources, we have to be able to produce these statistics on a common spatial unit, such as Eurostat INSPIRE grid, French municipalities, etc. Second, as evident from figure \@ref(fig:voronoi2007), the size of the Voronoi polygons depends on the local density of antennae : in rural areas, antennae distribution is sparse and thus polygons are large, and conversely for urban areas. This is not directly an issue for present population estimates, as this heterogeneity rightfully reflects the fact that estimates can't have the same precision everywhere. However, it can become problematic when these estimates are used in combination with other data sources, such as localized fiscal data to study social and spatial segregation, as it can cause modifiable areal unit problem (Openshaw, 1984) and so introduce bias.

Our research problem is thus to map events which are observed on the mobile network to a given input grid. Furthermore, we want to be able to incorporate any available information (MNOs data on antennae coverage, official statistics sources) that can improve the spatial accuracy of the mapping. Figure \@ref(fig:spatialmapping) sums up this procedure.

```{r spatialmapping, echo = FALSE, fig.align='center', fig.cap='Spatial mapping procedure', out.width='80%'}
knitr::include_graphics('sections/2_framework/spatial_mapping.png')
```




## A bayesian model to probabilize mobile phone events location

All along this report, we use a localization method of mobile phone users based on a framework developed by Tennekes (2018). It fundamentally relies on Bayes' theorem :
\begingroup \large
$$\mathbb{P}(tile_i | cell_j) \propto \mathbb{P}(tile_i) \mathbb{P}(cell_j | tile_i)$$
\endgroup
Each phone event is observed at a cell level, meaning the actual antenna transmitting the signal[^antenna_clarification]. The problem is then to infer in which tile[^tiles_cells] of the grid the mobile phone that generated this record was located. We want this location to be probabilized over the grid : as the only geographical information we have is the coordinates of the antenna to which the device has connected, we can never be certain of the actual location of the user. Bayes' rule states that this probability is proportional to any prior information we might have on each tile multiplied by the probability that the signal comes from a given cell knowing that the phone was on a particular grid tile.

[^antenna_clarification]: Up until now, we used the term "antenna" loosely. Yet it is important to distinguish the actual transmitter of the signal (the cell) and the antenna mast, on which multiple cells are generally located. When a phone event is observed, we know the specific cell to which the device has connected. Geographically speaking, this only gives us the coordinates of the mast on which it is located, next to some other cells. However, this is particularly important if we have access to information on cell technologies, because we can take it into account to compute probabilities based on theoretical coverage. In this report, we use the terms "antenna" and "cell" interchangeably, keeping in mind that geographical coordinates are those of the mast.

[^tiles_cells]: Tiles are the spatial units composing a grid. In spatial analysis, they are often also referred to as "cells", but we choose to call them "tiles" so as to distinguish them from antennae cells. In this report, we use tiles that are either squares (section \@ref(orange2007)) or rectangles (section \@ref(orange2019)).

This bayesian framework appears as a satisfactory solution to the research problem stated before. First, it can be computed on any given input grid. Second, it can accomodate a wide range of situations as regards information availability on antennae coverage from the MNO. Finally, various official statistics data sources can be mobilized to compute prior distributions on the chosen grid, so as to take into account the unequal probabilities of human presence on French territory. 

In subsequent sections, we provide two applications of this framework. Each time, we show how this methodology can be adapted to the specific use case. In section \@ref(orange2007), we implement it on a data set consisting in call detail records (CDR) of French MNO Orange customers in 2007. As no technical information on antennae is available for these data, we rely on traditional Voronoi modelization and show that incorporating prior information on tiles improves geographical localization of users. In section \@ref(orange2019), we perform the analysis on a recent data set consisting in signalling data from Orange customers in 2019. In this case, we make use of very thorough available data on the MNO radio wave propagation model to improve events localization. This enables us to propose an experimental indicator of present population for official statistics.


## Implementation as an R package : *mobicountR*

The bayesian framework we presented before was implemented using R programming language. To improve reproducibility of results, all functions used were gathered inside an R package called *mobicountR*. The detailled documentation of the package has been included in appendices. Here, we present the main functionalities of the package and how we use them in the analysis.

A first group of functions consist in tools for spatial analysis. Function *create_grid* enables one to create a regular grid over the bounding box of a spatial object (e.g. a country limits shapefile) for any desired size (i.e. the length of the side of a tile). Function *inter_grid_voronoi* performs geographical intersection between an input grid — which can be either an existing grid or a grid created using *create_grid* — and polygons of a Voronoi tessellation. These two functions are at the core of the analysis presented in section \@ref(orange2007), where we project data recorded at Voronoi level on a regular grid using the bayesian model to incorporate prior information on tiles. Finally, function *quadtree* implements the quadtree algorithm, which recursively splits an aggregated regular grid until a stop criterion is met. Since it consists in numerous self-calls of a same function, we wrote it in C++ language to reduce computation time, using R packages *Rcpp* (integration of R and C++) and *RcppArmadillo* (integration of Rcpp and C++ linear algebra library Armadillo). In section \@ref(orange2019), it is used to build an adaptive grid, i.e. an irregular rectangle grid which takes into account the fact that population estimates can't be computed at a same spatial resolution all over the territory because of heterogeneous densities of antennae. 

A second group of functions is devoted to prior distributions computation for the bayesian model. Function *prior_building* uses land cover registers to assign a probability to each tile of an input grid, which indicates whether it is likely that people reside in this tile, either permanently or temporarily. Probabilities are based on the relative building area or volume, depending on whether data on building heights are available. Building area/volume in each tile is computed by intersecting building shapefiles (in the case of France, BD Topo "bâti indifférencié") with each tile of the grid. As this step is highly computationally expensive, we enable the use of parallel computing — using R *foreach* package — over each element of a spatial unit (e.g. French departments). Missing building heights can be imputed using closest neighbour rule inside each spatial unit. In a similar way, function *prior_res_pop* uses geocoded individual data (census, tax data) to compute a prior distribution based on densities of resident population. Finally, we provide a function *prior_combine* which enables to combine multiple prior distributions over a same grid by computing a linear combination, the weights of which are chosen by the user.

A third group of functions serves to implement the bayesian framework, by computing posterior distribution over a given grid. Likelihoods are computed based on available information on antennae technology. Function *bay_voronoi* computes posterior over grid and Voronoi tessellation intersections, using relative shares of intersections as likelihood. Section \@ref(orange2007) is entirely based on the posterior distribution computed by this function, as no technical data on antennae was available for the data which are mobilized. In contrast, function *bay_coverage* computes posterior when antennae coverage maps, based on waves propagation model, are available from the MNO. This function is used in section \@ref(orange2019), as we had access to such maps along Orange 2019 signalling data.

Finally, we provide a fourth group of functions devoted to diagnostic analysis and quality evaluation.


