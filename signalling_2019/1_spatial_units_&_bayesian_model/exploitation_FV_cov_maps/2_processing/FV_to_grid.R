
# -----------------------------------------------------------------------------
# Adaptation of FluxVision antennas coverage maps to custom grid
# -----------------------------------------------------------------------------

install.packages("~/mobicount-project/minior-master.tar.gz", repos = NULL)

install.packages(c("fst"))

library(tidyverse)
library(data.table)
library(minior)
library(fst)
library(sf)
# library(RPostgreSQL)
# library(postGIStools)

set_minio_shared()

sfc_as_cols <- function(x, names = c("x","y")) {
  stopifnot(inherits(x,"sf") && inherits(sf::st_geometry(x),"sfc_POINT"))
  ret <- sf::st_coordinates(x)
  ret <- tibble::as_tibble(ret)
  stopifnot(length(names) == ncol(ret))
  x <- x[ , !names(x) %in% names]
  ret <- setNames(ret,names)
  df_final <- dplyr::bind_cols(x,ret)
  return(df_final)
}



# Import input tables from Minio ----------------------------------------------

# Import grid and convert to a csv with x,y columns

get_file_local(path_minio = "MobiCount/grids/grid_500_france.zip",
               bucket = "etgtk6",
               ext_dir = "~/grid",
               uncompress = T)

grid <- st_read("~/grid/grid_500_france.shp", crs = 2154)

# grid_ng <- grid %>%
#   st_set_geometry(NULL) %>%
#   separate(grid_id, into = c("x", "y")) %>%
#   mutate(x = as.numeric(x)*100, y = as.numeric(y)*100)
# 
# write_csv(grid_ng, "~/grid/grid_500_france.csv")
# 
# put_local_file("~/grid/grid_500_france.csv", 
#                dir_minio = "MobiCount/grids", 
#                bucket = "etgtk6")
# 
# grid_ng <- read_csv(get_file("MobiCount/grids/grid_500_france.csv", "etgtk6"))

# Extract FV grid from CSVs

get_file_local("MobiCount/fv/csg_02_19/indoor_02_19.fst",
               "etgtk6",
               ext_dir = "~/fv")

indoor <- read_fst("~/fv/indoor_02_19.fst", as.data.table = TRUE)
grid_indoor <- unique(indoor[, c("dma_name", "proba") := NULL])

get_file_local("MobiCount/fv/csg_02_19/outdoor_02_19.fst",
               "etgtk6",
               ext_dir = "~/fv")

outdoor <- read_fst("~/fv/outdoor_02_19.fst", as.data.table = TRUE)
grid_outdoor <- unique(outdoor[, c("dma_name", "proba") := NULL])

grid_fv <- unique(rbind(grid_indoor, grid_outdoor))
names(grid_fv) <- c("x", "y")

write_fst(grid_fv, "~/fv/grid_fv_02_19.fst", compress = 100, 
          uniform_encoding = TRUE)

put_local_file("~/fv/grid_fv_02_19.fst", 
               dir_minio = "MobiCount/fv/csg_02_19",
               bucket = "etgtk6")

# Convert FV grid to L93, and assign to 500m grid

grid_fv_l93 <- grid_fv %>%
  select(-proba, -dma_name) %>%
  st_as_sf(coords = c("x_tile", "y_tile"), crs = 27572) %>%
  st_transform(2154) %>%
  sfc_as_cols() %>%
  st_set_geometry(NULL) %>%
  mutate(x = round(x), y = round(y))
  




# Assigniation to 500m grid ---------------------------------------------------

fv_to_grid500 <- grid_fv[1:100,] %>%
  st_as_sf(coords = c("x_tile", "y_tile"), crs = 27572, remove = FALSE) %>%
  st_transform(2154) %>%
  sfc_as_cols() %>%
  st_set_geometry(NULL) %>%
  as_tibble() %>%
  mutate(x = round(x/500)*500/100,
         y = round(y/500)*500/100) %>%
  unite("grid_id_500", x, y, sep = "_") %>%
  select(-proba, -dma_name)

# Merge back to coverage table

cov_table_l93 <- merge(cov_table, fv_to_grid500)

# For each cell (<=> dma file), merge fv 100m tiles into the 500m tile
# in which they are located. Probabilities are summed accordingly.

cov_table_l93 <- cov_table_l93[, .(proba = sum(proba)), 
                                     by = .(dma_name, grid_id_500)]

# Probabilities are then renormalized so that they sum to one over
# each 500m tile

cov_table_l93 <- cov_table_l93[, proba := proba / sum(proba), 
                                              by = grid_id_500]

# Compute Shannon entropy for each 500m tile

grid_500_entropy <- cov_table_l93[, .(entropy = -sum((proba * log2(proba)) /
                                                        log2(.N)), max = max(proba)), 
                      by = grid_id_500]

grid_500_entropy <- grid_500_entropy[is.na(entropy), entropy := 0]


fwrite(cov_table_l93, "~/table_couvertures_FV_l93.csv")

put_local_file("~/table_couvertures_FV_l93.csv",
               dir_minio = "MobiCount/fv",
               bucket = "etgtk6")





# Quadtri on FV 100m grid -----------------------------------------------------














# # Put data on RPostgreSQL -----------------------------------------------------
# 
# con <- dbConnect(PostgreSQL(),
#                  dbname = "GridCoverage",
#                  user = "etgtk6",
#                  host = "postgis-5253189083136544796-etgtk6-users.marathon.containerip.dcos.thisdcos.directory",
#                  password = "changeme")
# 
# dbWriteTable(con, 'grid', grid_ng, row.names=FALSE)
# dbWriteTable(con, 'grid_fv', grid_fv, row.names=FALSE)
# 
# 
# 
# 
# # PostGIS treatment -----------------------------------------------------------
# 
# # Convert FV_grid to POLYGONS geometry, and convert to L93
# 
# q_fv_geom <-"CREATE TABLE grid_fv_geo AS
# SELECT dma_name, x_tile, y_tile, proba, 
# ST_Transform(
# ST_GeomFromText('POLYGON((' || 
# CAST(x_tile-50 AS CHAR(10)) || ' ' || CAST(y_tile+50 AS CHAR(10)) || ', ' || 
# CAST(x_tile+50 AS CHAR(10)) || ' ' || CAST(y_tile+50 AS CHAR(10)) || ', ' || 
# CAST(x_tile+50 AS CHAR(10)) || ' ' || CAST(y_tile-50 AS CHAR(10)) || ', ' || 
# CAST(x_tile-50 AS CHAR(10)) || ' ' || CAST(y_tile-50 AS CHAR(10)) || ', ' || 
# CAST(x_tile-50 AS CHAR(10)) || ' ' || CAST(y_tile+50 AS CHAR(10)) || '))',
# 27572),
# 2154) as geometry
# FROM grid_fv"
# 
# dbSendQuery(con, q_fv_geom)
# 
# # Convert grid to POLYGONS geometry
# 
# q_grid_geom <-"CREATE TABLE grid_geo AS
# SELECT x, y,
# ST_GeomFromText('POLYGON((' || 
# CAST(x-250 AS CHAR(10)) || ' ' || CAST(y+250 AS CHAR(10)) || ', ' || 
# CAST(x+250 AS CHAR(10)) || ' ' || CAST(y+250 AS CHAR(10)) || ', ' || 
# CAST(x+250 AS CHAR(10)) || ' ' || CAST(y-250 AS CHAR(10)) || ', ' || 
# CAST(x-250 AS CHAR(10)) || ' ' || CAST(y-250 AS CHAR(10)) || ', ' || 
# CAST(x-250 AS CHAR(10)) || ' ' || CAST(y+250 AS CHAR(10)) || '))',
# 2154) as geometry
# FROM grid"
# 
# dbSendQuery(con, q_grid_geom)
# 
# # Find tiles of fv_grid which are already contained in tiles from grid













